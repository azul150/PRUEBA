<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación TRABAJOS EN ALTURA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .question-number {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .options label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .options input {
            margin-right: 10px;
        }
        .user-info {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .certificate {
            display: none;
            border: 3px solid #3498db;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            background-color: white;
        }
        .certificate h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .certificate-info {
            margin-bottom: 20px;
            text-align: left;
        }
        .certificate-footer {
            text-align: left;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 30px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .download-btn {
            background-color: #27ae60;
            margin-top: 15px;
        }
        .download-btn:hover {
            background-color: #219653;
        }
        .options label.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        input:disabled {
            cursor: not-allowed;
        }
        .question.locked {
            background-color: #f9f9f9;
            border-color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EVALUACIÓN DE: TRABAJOS EN ALTURA</h1>
        
        <div id="userInfo" class="user-info" style="display: none;">
            <p><strong>Usuario:</strong> <span id="userDisplayName"></span></p>
            <p><strong>MEP:</strong> <span id="userMEP"></span></p>
            <p><strong>Región:</strong> <span id="userRegion"></span></p>
        </div>
        
        <div id="evaluationSection">
            <p><strong>Instrucción:</strong> Lee con atención y selecciona la respuesta correcta.</p>
            
            <form id="evaluationForm"></form>
            
            <div id="result" class="result" style="display: none;"></div>
            
            <div id="certificate" class="certificate">
                <h2>Comprobante de finalización del curso</h2>
                <h3>TRABAJO EN ALTURA</h3>
                
                <div class="certificate-info">
                    <p><strong>Nombre del usuario:</strong> <span id="certUserName"></span></p>
                    <p><strong>MEP:</strong> <span id="certMEP"></span></p>
                    <p><strong>Fecha de finalización:</strong> <span id="certDate"></span></p>
                </div>
                
                <div class="certificate-footer">
                    <p>Este comprobante no tiene valor oficial y solo puede ser canjeado en el Área de Capacitación</p>
                </div>
                
                <button class="download-btn" id="downloadBtn">Descargar Comprobante</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS (TRABAJO EN ALTURA) ---
        const questionsDatabase = [
            {
                id: 1,
               question: "¿Qué es una Caída Libre?",
                options: [
                    "Caída de una Herramienta de un nivel a otro",
                    "Es el movimiento acelerado que adquiere un cuerpo bajo la acción exclusiva de la fuerza de gravedad.",
                    "Caída que sufre un trabajador cuando se tropieza"
                ],
                correctAnswer: 'b',
                type: 'radio'
            },
            {
                id: 2,
                question: "Procedimiento para Casos de Caídas desde Altura:",
                options: [
                    "Detener inmediatamente las actividades; de ser necesario, evacuar el lugar.",
                    "Informar a las autoridades (Secretaría del Trabajo y Previsión Social)",
                    "Reanudar los trabajos sólo previa autorización de las autoridades.",
                    "Todas las Anteriores"
                ],
                correctAnswer: 'd',
                type: 'radio'
            },
            {
                id: 3,
                question: "Causas de Caídas desde Altura:",
                options: [
                    "Actos Personales Incorrectos",
                    "Por falta de conocimientos",
                    "Por falta de capacidades",
                    "Principalmente por falta de valorización de la seguridad",
                    "Todas las anteriores"
                ],
                correctAnswer: 'e',
                type: 'radio'
            },
            {
                id: 4,
                question: "Antes de iniciar cualquier labor en altura, todos los trabajadores deberán recibir una completa formación, sobre la forma de desarrollar su labor con alta seguridad. Los temas obligatorios incluídos en la capacitación deberán ser:",
                options: [
                    "Riesgos del trabajo en altura, EPP adecuados para cada trabajo, Sistemas de protección personales necesarios para desarrollar el trabajo.",
                    "Componentes del sistema de protección, Prescripciones y limitaciones de uso, Armado del o los sistemas de protección, uso del o los sistemas y de los equipos de protección personal",
                    "Técnicas de conexión y anclaje, Inspección, mantenimiento y almacenamiento de equipos y sistemas de protección, Instalaciones, herramientas y equipos anexos que pudieran requerirse",
                    "Todas las anteriores"
                ],
                correctAnswer: 'd',
                type: 'radio'
            },
            {
                id: 5,
                question: "¿Cuánto debe resistir en kg por cada trabajador el punto de Anclaje?",
                options: [
                    "2,226 kg por cada trabajador anclado",
                    "4,452 kg por cada trabajador anclado",
                    "1,216 kg por cada trabajador anclado",
                    "Todas las anteriores"
                ],
                correctAnswer: 'a',
                type: 'radio'
            },
            {
                id: 6,
                question: "¿A que altura se debe de usar el arnés de seguridad?",
                options: [
                    "2 metros.",
                    "1.80 metros.",
                    "1.40 metros."
                ],
                correctAnswer: 'b',
                type: 'radio'
            }
        ];

        let randomizedQuestions = [];

        document.addEventListener('DOMContentLoaded', function() {
            const savedUserData = localStorage.getItem('userData');
            if (savedUserData) {
                const userData = JSON.parse(savedUserData);
                showUserInfo(userData);
                generateRandomQuestions();
            } else {
                alert('No hay una sesión activa. Serás redirigido al sistema de inicio de sesión.');
                window.location.href = 'index.html';
            }
        });
        
        function showUserInfo(userData) {
            const userDisplayName = `${userData.firstName} ${userData.lastName}`;
            document.getElementById('userDisplayName').textContent = userDisplayName;
            document.getElementById('userMEP').textContent = userData.mep;
            document.getElementById('userRegion').textContent = userData.region;
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('certUserName').textContent = userDisplayName;
            document.getElementById('certMEP').textContent = userData.mep;
        }

        function generateRandomQuestions() {
            const questionsCopy = [...questionsDatabase];
            for (let i = questionsCopy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questionsCopy[i], questionsCopy[j]] = [questionsCopy[j], questionsCopy[i]];
            }
            randomizedQuestions = questionsCopy;
            renderQuestions();
        }

        function renderQuestions() {
            const form = document.getElementById('evaluationForm');
            form.innerHTML = '';
            
            randomizedQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                
                const questionNumber = document.createElement('div');
                questionNumber.className = 'question-number';
                questionNumber.innerHTML = `${index + 1}. ${question.question}`;
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options';
                
                question.options.forEach((option, optionIndex) => {
                    const letter = String.fromCharCode(97 + optionIndex);
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    
                    input.type = question.type; 
                    input.name = `q${question.id}`;
                    input.value = letter;
                    
                    label.appendChild(input);
                    const textSpan = document.createElement('span');
                    textSpan.innerHTML = ` ${option}`;
                    label.appendChild(textSpan);
                    optionsDiv.appendChild(label);
                });
                
                questionDiv.appendChild(questionNumber);
                questionDiv.appendChild(optionsDiv);
                form.appendChild(questionDiv);
            });
            
            const newGradeBtn = document.createElement('button');
            newGradeBtn.type = 'button';
            newGradeBtn.id = 'gradeBtn';
            newGradeBtn.textContent = 'Calificar Evaluación';
            newGradeBtn.disabled = true; 
            form.appendChild(newGradeBtn);
            
            newGradeBtn.addEventListener('click', gradeEvaluation);
            
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', checkAllQuestionsAnswered);
            });
        }
        
        function checkAllQuestionsAnswered() {
            let allAnswered = true;
            randomizedQuestions.forEach(q => {
                const name = `q${q.id}`;
                const checked = document.querySelector(`input[name="${name}"]:checked`);
                if (!checked) allAnswered = false;
            });
            document.getElementById('gradeBtn').disabled = !allAnswered;
        }
        
        function lockQuestionsAfterGrading() {
            const allInputs = document.querySelectorAll('input');
            allInputs.forEach(input => input.disabled = true);
            const allLabels = document.querySelectorAll('.options label');
            allLabels.forEach(label => label.classList.add('disabled'));
            const allQuestions = document.querySelectorAll('.question');
            allQuestions.forEach(question => question.classList.add('locked'));
            
            const gradeBtn = document.getElementById('gradeBtn');
            if (gradeBtn) {
                gradeBtn.disabled = true;
                gradeBtn.textContent = 'Evaluación Completada';
                gradeBtn.style.backgroundColor = '#95a5a6';
            }
        }
        
        function gradeEvaluation() {
            let score = 0;
            const totalQuestions = randomizedQuestions.length;
            
            randomizedQuestions.forEach(q => {
                const name = `q${q.id}`;
                const selected = document.querySelector(`input[name="${name}"]:checked`);
                if (selected && selected.value === q.correctAnswer) {
                    score++;
                }
            });
            
            const percentage = (score / totalQuestions) * 100;
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = `Obtuviste ${score} de ${totalQuestions} respuestas correctas (${percentage.toFixed(2)}%)`;
            
            lockQuestionsAfterGrading();
            enviarDatosAGoogle(score, percentage);
            
            if (percentage >= 80) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML += '<br>¡Felicidades! Has aprobado la evaluación.';
                document.getElementById('certDate').textContent = new Date().toLocaleDateString();
                document.getElementById('certificate').style.display = 'block';
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML += '<br>No has alcanzado el 80% necesario. Inténtalo de nuevo.';
                setTimeout(function() {
                    alert('Tu progreso ha sido reiniciado.');
                    window.location.href = '../../index.html';
                }, 4000);
            }
        }

        document.getElementById('downloadBtn').addEventListener('click', function(){
            const userData = JSON.parse(localStorage.getItem('userData'));
            if(!userData) return;

            const canvas = document.createElement('canvas');
            canvas.width = 1000;
            canvas.height = 700;
            const ctx = canvas.getContext('2d');

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, "#f0f8ff");
            gradient.addColorStop(1, "#ffffff");
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = "#3498db";
            ctx.lineWidth = 8;
            ctx.strokeRect(30, 30, canvas.width - 60, canvas.height - 60);

            ctx.fillStyle = "#2c3e50";
            ctx.font = "bold 38px Georgia";
            ctx.textAlign = "center";
            ctx.fillText("Comprobante de Finalización del Curso:", canvas.width/2, 120);
            ctx.fillText("TRABAJOS EN ALTURA", canvas.width/2, 170);

            ctx.font = "bold 30px Arial";
            ctx.fillStyle = "#000";
            ctx.fillText("Se otorga el presente comprobante a:", canvas.width/2, 240); 

            ctx.font = "bold 36px 'Times New Roman'";
            ctx.fillStyle = "#3498db";
            const userName = `${userData.firstName} ${userData.lastName}`;
            ctx.fillText(userName.toUpperCase(), canvas.width/2, 320); 

            ctx.font = "bold 26px Arial";
            ctx.fillStyle = "#333";
            ctx.fillText(`MEP: ${userData.mep}`, canvas.width/2, 400); 
            ctx.fillText(`Finalizado el: ${new Date().toLocaleDateString()}`, canvas.width/2, 470); 

            ctx.font = "bold italic 18px Arial";
            ctx.fillStyle = "#666";
            ctx.textAlign = "left";
            ctx.fillText("El comprobante no tiene validez legal y para la elaboración y", 60, 600);
            ctx.fillText("entrega de DC-3, favor de presentar este documento en el área de capacitación.", 60, 620);

            const link = document.createElement('a');
            link.download = `Comprobante_${userName.toUpperCase()}_ALTURAS.jpg`;
            link.href = canvas.toDataURL('image/jpeg');
            link.click();
            setTimeout(function() { window.location.href = '../../index.html'; }, 1000);
        });

        function enviarDatosAGoogle(score, percentage) {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (!userData) return;
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxuR8MxitRISWI0XHlhGb9oY_wqr8riDrlJX5mu5X2cmqGHogsIfdBEiaSbpviLcWFL/exec'; // Inserta tu URL de Google Apps Script
            const formData = new FormData();
            formData.append('nombre', `${userData.firstName} ${userData.lastName}`);
            formData.append('mep', userData.mep);
            formData.append('region', userData.region); 
            formData.append('score', score);
            formData.append('percentage', percentage.toFixed(2));
            
            const resultDiv = document.getElementById('result');
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '<small style="color:blue"><i>Sincronizando...</i></small>';
            resultDiv.appendChild(loadingMsg);

            fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => {
                loadingMsg.innerHTML = '<small style="color:green"><b>✓ Guardado.</b></small>';
            });
        }
    </script>
</body>
</html>